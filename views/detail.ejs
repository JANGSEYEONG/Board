<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/index.css" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <title>Document</title>
</head>

<body class="grey-bg">
    <%- include('nav.ejs', user) %>

        <div class="detail-bg">

            <!--ê²Œì‹œê¸€ í—¤ë” ì˜ì—­-->
            <% if(list.writerId.toString()===user._id.toString()) { %>
                <a href="/post/edit/<%= list._id %>">âœï¸</a>
                <span data-id="<%= list._id %>" class="delete devDelPost">ğŸ—‘ï¸</span>
                <% } %>

                    <h6>ì‘ì„±ì : <%= list.writerNick %>
                    </h6>
                    <span>
                        <%= list.time %>
                    </span>

                    <% if(list.isEdit) { %>
                        <span>ìˆ˜ì •ë¨</span>
                        <% } %>

                            <!--ê²Œì‹œê¸€ ë‚´ìš© ì˜ì—­-->
                            <h4>
                                <%= list.title %>
                            </h4>
                            <p>
                                <%= list.content %>
                            </p>
                            <img src="<%= list.img %>" />

                            <!--ëŒ“ê¸€ ì˜ì—­-->
                            <hr style="margin-top: 60px" />
                            <div>
                                <% for (let i=0; i < comments.length; i++) { %>
                                    <div>
                                        <span>
                                            <strong>[<%= comments[i].writer %>] </strong>
                                            <span class="devCommentContent">
                                                <%= comments[i].content %>
                                            </span>
                                            <input class="devEditInput" style="display: none;" type="text"
                                                value="<%= comments[i].content %>" />
                                        </span>
                                        <% if(comments[i].writerId.toString()===user._id.toString()) { %>
                                            <span data-id="<%= comments[i]._id %>" class="devEditComment">âœï¸</span> <!--âœ”ï¸-->
                                            <span class="devEditCancelComment" style="display: none;">âŒ</span>
                                            <span data-id="<%= comments[i]._id %>"
                                                class="delete devDelComment">ğŸ—‘ï¸</span>
                                            <% } %>
                                    </div>
                                    <% } %>
                            </div>
                            <hr />
                            <form action="/comment/add" method="POST">
                                <input name="content" />
                                <input name="parentPostId" value="<%= list._id %>" style="display: none" />
                                <button type="submit">ëŒ“ê¸€ì‘ì„±</button>
                            </form>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"></script>
        <script>
            // ê²Œì‹œê¸€ ì‚­ì œ
            const delPostBtns = document.querySelectorAll('.devDelPost');
            delPostBtns.forEach((btn) => {
                btn.addEventListener('click', function (event) {
                    axios
                        .delete(`/post/delete?id=${this.dataset.id}`)
                        .then((r) => {
                            let msg;
                            if (parseInt(r.data) < 1) {
                                msg = 'ì‚­ì œí•  ê²Œì‹œë¬¼ì´ ì—†ê±°ë‚˜ ì‘ì„±ìê°€ ì•„ë‹™ë‹ˆë‹¤.';
                            } else {
                                msg = 'ì‚­ì œ ì™„ë£Œ';
                                //í™”ì‚´í‘œí•¨ìˆ˜ì—¬ì„œ ë°”ê¹¥ì˜ this ìœ ì§€ ê°€ëŠ¥
                                // this.parentElement.parentElement.style.display = 'none';
                                location.href = '/list';
                            }
                            alert(msg);
                        })
                        .catch((e) => {
                            console.log(e);
                        });
                });
            });

            // ëŒ“ê¸€ ì‚­ì œ
            const delCommentBtns = document.querySelectorAll('.devDelComment');
            delCommentBtns.forEach((btn) => {
                btn.addEventListener('click', function (event) {
                    axios
                        .delete(`/comment/delete?id=${this.dataset.id}`)
                        .then((r) => {
                            let msg;
                            if (parseInt(r.data) < 1) {
                                msg = 'ì‚­ì œí•  ê²Œì‹œë¬¼ì´ ì—†ê±°ë‚˜ ì‘ì„±ìê°€ ì•„ë‹™ë‹ˆë‹¤.';
                            } else {
                                msg = 'ì‚­ì œ ì™„ë£Œ';
                                //í™”ì‚´í‘œí•¨ìˆ˜ì—¬ì„œ ë°”ê¹¥ì˜ this ìœ ì§€ ê°€ëŠ¥
                                this.parentElement.style.display = 'none';
                                //location.href = '/list';
                            }
                            alert(msg);
                        })
                        .catch((e) => {
                            console.log(e);
                        });
                });
            });

            // ëŒ“ê¸€ ìˆ˜ì •
            const editCommentBtns = document.querySelectorAll('.devEditComment');
            editCommentBtns.forEach((btn) => {
                btn.addEventListener('click', function (event) {

                    // 1. í˜„ì¬ ìƒíƒœ ì €ì¥ (inputì˜ show ìœ ë¬´ì— ë”°ë¼ ì„¤ì •)
                    const editInput = this.parentElement.querySelector('.devEditInput');
                    let isEditing = !(editInput.style.display === "none");

                    // 2. ìƒíƒœì— ë”°ë¼ ë™ì‘ ë¶„ê¸°
                    if (isEditing) {
                        // ì²´í¬ í‘œì‹œ í´ë¦­ ì‹œ

                        // 1. ìˆ˜ì • ìš”ì²­ ë³´ë‚´ê¸°
                        // 1-1) ìƒˆë¡œìš´ ëŒ“ê¸€ value ì €ì¥
                        let data = editInput.value;
                        let commentId = this.dataset.id;

                        if (data == "" || data == undefined || data == null) {
                            alert("ë‚´ìš©ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
                            return;
                        }
                        // 1-2) axiosë¡œ ì„œë²„ì— ì „ì†¡
                        let sendData = {
                            id : commentId,
                            content : data
                        }
                        axios
                            .put("/comment/edit", sendData)
                            .then((r) => {
                                let msg;
                                console.log(r.data);

                                // 1-3) ì„œë²„ ì²˜ë¦¬ ê²°ê³¼ì— ë”°ë¼ ì²˜ë¦¬
                                if(parseInt(r.data) > 0) {
                                    // ì„±ê³µ ì‹œ, ì•„ì´ì½˜ ë° ìƒíƒœ ë³€ê²½
                                    msg = "ìˆ˜ì • ì™„ë£Œ";

                                    this.parentElement.querySelector(".devCommentContent").innerHTML = data;
                                    this.parentElement.querySelector(".devEditInput").value = data;

                                    chgEditStatucComment(this, false);
                                } else if(parseInt(r.data) < 0) {
                                    // ëŒ“ê¸€ ë¹„ì–´ìˆìŒ í‘œì‹œ
                                    msg = "ë‚´ìš©ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.";
                                    
                                } else {
                                    // ì‹¤íŒ¨ ì‹œ, ìœ ì§€
                                    msg = "ìˆ˜ì •í•  ëŒ“ê¸€ì´ ì—†ê±°ë‚˜ ì‘ì„±ìê°€ ì•„ë‹™ë‹ˆë‹¤.";
                                }
                                
                                // ê²°ê³¼ ë©”ì„¸ì§€ ë„ìš°ê¸°
                                alert(msg);
                            })
                            .catch((e) => {
                                console.log(e);
                            });
                    } else {
                        // ì—°í•„ í‘œì‹œ í´ë¦­ ì‹œ

                        // 1. ì•„ì´ì½˜ ë° ìƒíƒœ ë³€ê²½
                        chgEditStatucComment(this, true);
                    }
                });
            });

            const editCancelBtns = document.querySelectorAll('.devEditCancelComment');
            editCancelBtns.forEach((btn) => {
                btn.addEventListener('click', function (event) {
                    chgEditStatucComment(this, false);
                });
            });

            const chgEditStatucComment = (target, goEdit) => {
                if (goEdit) {
                    // 1. inputì°½ show
                    target.parentElement.querySelector('.devEditInput').style.display = "inline";

                    // 2. ì²´í¬í‘œì‹œë¡œ text ë³€ê²½
                    target.parentElement.querySelector('.devEditComment').innerHTML = 'âœ”ï¸';

                    // 3. ìˆ˜ì • ì·¨ì†Œ ë²„íŠ¼ show
                    target.parentElement.querySelector('.devEditCancelComment').style.display = "inline";

                    // 4. ê¸°ì¡´ ëŒ“ê¸€ íƒœê·¸ hide
                    target.parentElement.querySelector('.devCommentContent').style.display = "none";
                } else {
                    // 1. inputì°½ hide
                    target.parentElement.querySelector('.devEditInput').style.display = "none";

                    // 2. ì—°í•„ í‘œì‹œë¡œ text ë³€ê²½
                    target.parentElement.querySelector('.devEditComment').innerHTML = 'âœï¸';

                    // 3. ìˆ˜ì • ì·¨ì†Œ ë²„íŠ¼ hide
                    target.parentElement.querySelector('.devEditCancelComment').style.display = "none";

                    // 4. ê¸°ì¡´ ëŒ“ê¸€ íƒœê·¸ show
                    target.parentElement.querySelector('.devCommentContent').style.display = "inline";
                }
            }
        </script>
</body>

</html>